import { ArgsTable, Canvas, Meta, Story } from "@storybook/addon-docs";
import { Grid, GridColumn } from "@jpmorganchase/uitk-grid";
import { withFlexGap } from "docs/decorators/withFlexGap";
import {
  CharacteristicUsage,
  CSSClassTable,
} from "css-variable-docgen-components";

<Meta
  title="Documentation/Grid/Grid"
  component={Grid}
  parameters={{
    viewMode: "docs",
  }}
/>

# Grid

A Grid presents tabular information that has columns and rows.
Grid is particularly useful if the tabular information is editable or interactive, various use cases include:

- Data input, such as editing notional values
- Real-time data display, such as executed trades
- Inline cell or row-based actions, such as cancelling trades

Grid provides users with intuitive and efficient keyboard navigation, filtering, content editing, selection, and copy and paste.

Grid is virtualized. Only the visible part is rendered to the DOM.

## Configuring Grid

Run command below to install `@jpmorganchase/uitk-grid` package.

```sh
yarn add @jpmorganchase/uitk-grid;
```

```sh
npm install @jpmorganchase/uitk-grid;
```

Use the following call to import Grid.

```
import { Grid } from "@jpmorganchase/uitk-grid";
```

Note: ensure CSS `height` property for `.grid` has been set appropriately to see grid on screen

### Props

<ArgsTable of={Grid} />

## Grid variants

Grid contains two variants:

1. `primary`: the default mode. Zebra is available on `primary` variant, i.e. `zebra={true}`
2. `secondary`

Column separators can be enabled using `columnSeparators` property.

<Canvas>
  <Story id="grid-new-grid--grid-variants" decorators={[withFlexGap]} />
</Canvas>

### Columns

Grid columns can be configured using the `GridColumn` component.

The Grid package contains three types of predefined columns:

1. `RowSelectionCheckboxColumn`: cell values of type `RowSelectionCheckboxCellValue` contain checkboxes, allows multiple selection and values are left aligned by default.
2. `RowSelectionRadioColumn`: cell values of type `RowSelectionRadioCellValue` contain radio buttons, allows single selection only and values are left aligned by default.
3. `NumericColumn`: cell values of type `NumericCellValue`, values are right aligned only.

Each one of them renders a `GridColumn` with a specific set of props.
You can easily create any project-specific column types tailored to your needs using the same approach.

#### GridColumn props

<ArgsTable of={GridColumn} />{" "}

### Column groups

Columns can be grouped using the `ColumnGroup` component.

Note: whenever a `ColumnGroup` component is present, all other Grid's children will also need to be wrapped within a `ColumnGroup` component.

<Canvas>
  <Story id="grid-new-grid--column-groups" decorators={[withFlexGap]} />
</Canvas>

### Rows

Grid rows are created by providing an array of objects in the `rowData` property of the grid.
`rowData` also accepts sparse arrays.
When used in combination with the `onVisibleRowRangeChange` callback this allows for lazy loading (server-side data) scenarios.

[Here's an example](https://uitk.pages.dev/?path=/story/grid-new-grid--server-side-data) that details using sparse array and `onVisibleRowRangeChange` callback.

<Canvas>
  <Story id="grid-new-grid--server-side-data" />
</Canvas>

### Row selection

Grid supports three variants of row selection:

1. Single row selection
2. Multi-row selection
3. None (rows cannot be selected)

`RowSelectionCheckboxColumn` is useful in `multi` row selection mode, and `RowSelectionRadioColumn` works best in `single` row selection mode.
Both are optional.

#### Uncontrolled mode

In [uncontrolled mode](https://reactjs.org/docs/uncontrolled-components.html) you can provide `defaultSelectedRowIdxs` and the grid maintains the selection state. It accepts `number[]`, and works only when `rowSelectionMode` is `single` or `multi`.

<Canvas>
  <Story id="grid-new-grid--row-selection-modes" decorators={[withFlexGap]} />
</Canvas>

#### Controlled mode

In [controlled mode](https://reactjs.org/docs/forms.html#controlled-components) you can provide `selectedRowIdxs` and update it when `onRowsSelected` callback is invoked.
Below is an example of how to use controlled selection mode to synchronise selection in two grids.

<Canvas>
  <Story
    id="grid-new-grid--row-selection-controlled"
    decorators={[withFlexGap]}
  />
</Canvas>

### Cell customization

Grid allows the use of any renderable react components for cell customization. There is two ways to customize cell appearance:

1. `cellValueComponent` (recommended)
2. `cellComponent`

The `cellValueComponent` property of `GridColumn` component is the most convenient extension point. It handles cell values and functionalities like on hover highlighting, selection, cursor and focus.
Below is an example of custom components applied to `cellValueComponent` of "Bid/Ask", "Percentage" and "Buttons" columns, [more details here](https://uitk.pages.dev/?path=/story/grid-new-grid--cell-customization).

<Canvas>
  <Story id="grid-new-grid--cell-customization" decorators={[withFlexGap]} />
</Canvas>

Second way to customize cell appearance is the `cellComponent` property.
Unlike `cellValueComponent` it replaces the entire cell element rather than its content and allows you to implement more radical customization scenarios.
Please note that if you override `cellComponent` you will need to handle all basic functionality typically provided by the default cell implementation,
therefore it is recommended that you only use `cellComponent` if `cellValueComponent` does not provide enough flexibility.

### Header customization

Column headers and column group headers can be customized using the `headerValueComponent` property which is demonstrated by the grid below.

- The "Items sold" column group has a group of toggle buttons that change the appearance of the group between "monthly", "quarterly" and "summary" modes.
- The "Item" column group has a button to toggle between pinned and unpinned modes.
- The "Name" and "Price" columns have custom headers that indicate sort direction.

This grid also shows an example of a custom cell displaying a basic chart. Switch the "Items sold" column to "summary" mode to see it.

<Canvas>
  <Story id="grid-new-grid--header-customization" decorators={[withFlexGap]} />
</Canvas>

### Editable cells

Grid allows you to make cell values editable in place.

Use the `CellEditor` (a non-rendered) component as a child of `GridColumn` to make the column editable.
`CellEditor` is expected to have one child representing the specific editor component to use for the column.
The child of the `CellEditor` component gets rendered in the focused cell when the grid goes to edit mode.

We have [three sample components](https://uitk.pages.dev/?path=/story/grid-new-grid--editable-cells) created for use as `CellEditor`'s child,
i.e. `TextCellEditor`, `DropdownCellEditor` and `NumericCellEditor`.
You can easily create any components tailored to your needs using the same approach.

<Canvas>
  <Story id="grid-new-grid--editable-cells" decorators={[withFlexGap]} />
</Canvas>

To trigger edit mode on cells on your...

- keyboard: `backspace` key _or_ `F2` key _or_ simply start typing
- mouse: double click

### Pagination

[Implement pagination](https://uitk.pages.dev/?path=/story/lab-pagination--default-pagination) using the `Paginator` component. It is not a feature of the grid itself.

```
import { Pagination, Paginator } from "@jpmorganchase/uitk-lab";

interface PaginationProps {
  count: number
  page?: number
  onPageChange?: ((page: number) => void)
  initialPage?: number
  compact?: Boolean
}

interface PaginatorProps {
  boundaryCount?: number;
  siblingCount?: number;
  showPreviousNext?: boolean;
  FormFieldProps?: Partial<FormFieldProps>;
}
```

<Canvas>
  <Story id="grid-new-grid--grid-pagination" decorators={[withFlexGap]} />
</Canvas>

### Writing tests for Grid component

Grid utilises virtualization to load content and renders only what’s in the viewport.
As previously fetched data leave the viewport, so do the DOM notes.

Note that if your test expects an element to be rendered, and it is out of the viewport, the test will not find the element - that is expected behaviour.
To make tests work, ensure your grid is big enough and have scrolling implemented, closely mimicking how a user would experience using it.

### CSS Class

<CSSClassTable of={Grid} />

### Characteristics used

<CharacteristicUsage of={Grid} />

### --uitkGrid CSS custom property API

The default styling values for most Grid attributes are provided by the theme variables. A smaller number of attributes
use hard-coded values local to Grid. Both of these can be overridden, see Theme documentation for detailed usage guidance.

The CSS custom properties below are consumed by Grid, but not defined by Grid. They can be defined via a container or
a custom class name to override grid styling. They will always take precedence over default styles, whether from theme variables
or declared locally. Again, see Theme documentation for guidance on when to use variables from the custom property API.

The grid below is editable. Change the values of CSS variables to view their effect on the grid.

<Canvas>
  <Story id="grid-new-grid--css-variables" decorators={[withFlexGap]} />
</Canvas>

# Accessibility

Grid is accessible by assistive technologies like screen readers, and provides full WAI-ARIA support.

## Keyboard interactions

The following keyboard interactions apply to the Grid component:

_Note: the keys below represent the expected interaction on Windows OS. For Mac replace <kbd>Ctrl</kbd> with <kbd>Cmd</kbd>._

### Grid navigation

| Key                                 | Function                                                                                                                                                                                                                                            |
| ----------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <kbd>Tab</kbd>                      | - If focus is before the grid, put focus on the last focused grid cell or the first cell if the grid is receiving focus for the first time. <br /> - If focus is in the grid, move focus to next component in the tab order outside of the grid.    |
| <kbd>Shift</kbd> and <kbd>Tab</kbd> | - If focus is after the grid, put focus on the last focused grid cell or the first cell if the grid is receiving focus for the first time. <br /> - If focus is in the grid, move focus to previous component in the tab order outside of the grid. |
| <kbd>►</kbd>                        | - Move focus one cell to the right. <br /> - If the last cell in the row, focus does not wrap.                                                                                                                                                      |
| <kbd>◄</kbd>                        | - Move focus one cell to the left. <br /> - If the first cell in the row, focus does not wrap.                                                                                                                                                      |
| <kbd>▲</kbd>                        | - Move focus one cell up. <br /> - If the first cell in the column, focus does not wrap.                                                                                                                                                            |
| <kbd>▼</kbd>                        | - Move focus one cell down. <br /> - If the last cell in the column, focus does not wrap.                                                                                                                                                           |
| <kbd>Home</kbd>                     | If focus is on a grid cell, moves focus to first cell in the current row.                                                                                                                                                                           |
| <kbd>End</kbd>                      | If focus is on a grid cell, moves focus to last cell in the current row.                                                                                                                                                                            |
| <kbd>Ctrl</kbd> and <kbd>Home</kbd> | If focus is on a grid cell, moves focus to first cell in the grid.                                                                                                                                                                                  |
| <kbd>Ctrl</kbd> and <kbd>End</kbd>  | If focus is on a grid cell, moves focus to last cell in the grid.                                                                                                                                                                                   |
| <kbd>Page up</kbd>                  | If focus is on a grid cell, scrolls to the next page of rows and moves focus to the first visible cell in the current column.                                                                                                                       |
| <kbd>Page down</kbd>                | If focus is on a grid cell, scrolls to the previous page of rows and moves focus to the first visible cell in the current column.                                                                                                                   |

### Grid selection

| Key                                      | Function                                                                                                                                                                                                                                                                                                                     |
| ---------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <kbd>Spacebar</kbd>                      | - If focus is on a cell, toggles the selection state of the row and always deselects a previous selected row (single and multi-select). <br /> - If focus is on a row checkbox, adds (or removes) the row to row multiple selection.                                                                                         |
| <kbd>Shift</kbd> and <kbd>Spacebar</kbd> | - If focus is on any cell, toggles the selection state of its row and deselects any previous row selection. <br /> - If the grid supports multiple selection (i.e., rows contain checkboxes), when any cell in the row has focus, toggles the row's checkbox state and adds to (or removes from) the multiple row selection. |
| <kbd>Ctrl</kbd> and <kbd>C</kbd>         | Coplies selection to clipboard.                                                                                                                                                                                                                                                                                              |
| <kbd>Ctrl</kbd> and <kbd>X</kbd>         | Cuts selection to clipboard.                                                                                                                                                                                                                                                                                                 |

### Interacting with editable cells

| Key                                   | Function                                                                                                                                                                                                                               |
| ------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <kbd>Return</kbd> or <kbd>Enter</kbd> | - If focus is on an editable input cell, moves cell to edit mode and hightlights existing characters. <br /> - If the cell is in edit mode, stores the value, returns cell to default state and moves focus one cell down.             |
| <kbd>F2</kbd>                         | If focus is on an editable input cell, toggles between default and edit modes. Any value changes are stored.                                                                                                                           |
| <kbd>Backspace</kbd>                  | If focus is on an editable input cell, moves cell to edit mode and deletes existing characters.                                                                                                                                        |
| <kbd>Tab</kbd>                        | - If an editable cell is in edit mode **only**, returns to default state and moves focus to next cell on the right. Cell values are stored. <br /> - If the editable cell is the last cell in the grid, focus stays over current cell. |
| <kbd>Shift</kbd> and <kbd>Tab</kbd>   | - If an editable cell is in edit mode **only**, returns to default state and moves focus to next cell on the left. Cell values are stored. <br /> - If the editable cell is the last cell in the grid, focus stays over current cell.  |
| <kbd>Esc</kbd>                        | If an editable cell is active, reverts any changes to the input and returns the cell to default state.                                                                                                                                 |
| Alphanumeric keys                     | If focus is on an editable input cell, enters the typed characters and replaces current characters.                                                                                                                                    |
| <kbd>Ctrl</kbd> and <kbd>V</kbd>      | Pastes values to cell/s.                                                                                                                                                                                                               |
| <kbd>Ctrl</kbd> and <kbd>Z</kbd>      | Undo last action.                                                                                                                                                                                                                      |
| <kbd>Ctrl</kbd> and <kbd>Y</kbd>      | Redo last action.                                                                                                                                                                                                                      |

# Help and support

Please check the [issues section of our github repository](https://github.com/jpmorganchase/uitk/issues) for any design or development issues you have.

If you're unable to find an open issue addressing the problem, open a new one. Be sure to include a title and clear description, as much relevant information as possible, any relevant code samples, and details of the expected behavior.

If your issue has already been raised and the issue is still open, add a comment to the existing issue instead of opening a new one.
