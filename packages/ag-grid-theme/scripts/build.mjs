import chokidar from "chokidar";
import path from "node:path";
import fs from "fs-extra";
import { fileURLToPath, pathToFileURL } from "url";
import { createRequire } from "module";
import { deleteSync } from "del";
import sass from "sass";
import postcss from "postcss";
import cssnano from "cssnano";
import url from "postcss-url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const require = createRequire(import.meta.url);

function buildStyles(entry) {
  console.log(`Building "${entry}"`);

  const sourceFileName = path.basename(entry);
  const outputFileName = sourceFileName.replace(/\.scss$/, ".css");
  const outputFolder = path.join(
    __dirname,
    "../../../dist/salt-ds-ag-grid-theme"
  );
  const outputName = path.join(outputFolder, sourceFileName);
  deleteSync([outputName], { force: true });
  const result = sass.compile(entry, {
    // https://sass-lang.com/documentation/js-api/interfaces/FileImporter
    importers: [
      {
        // An importer that redirects relative URLs starting with "~" to
        // `node_modules`.
        findFileUrl(url) {
          if (!url.startsWith("~")) return null;

          const nonPrefixedUrl = url.substring(1);
          const resolvedFile = require.resolve(
            nonPrefixedUrl.substring(0, nonPrefixedUrl.indexOf("/"))
          );
          const fileUrl = pathToFileURL(
            resolvedFile.substring(0, resolvedFile.indexOf("node_modules") + 13)
          );

          return new URL(nonPrefixedUrl, fileUrl);
        },
      },
    ],
  });

  postcss([
    cssnano({
      preset: ["default", { normalizeWhitespace: false }],
    }),
    url({
      url: "inline",
      basePath: path.resolve(__dirname, "../fonts"),
    }),
  ])
    .process(result.css, { from: undefined })
    .then((optimizedResult) => {
      const resultCSS = `/**** Auto generated by packages/ag-grid-theme/scripts/build.mjs ****/\n\n${optimizedResult.css}`;

      fs.mkdirSync(outputFolder, { recursive: true });
      fs.writeFileSync(path.join(__dirname, "..", outputFileName), resultCSS);
      fs.writeFileSync(path.join(outputFolder, outputFileName), resultCSS);

      fs.copyFileSync(
        path.resolve(__dirname, "../package.json"),
        path.join(outputFolder, "package.json")
      );
    });
}

const inputFolder = path.resolve(__dirname, "../css");
const entries = fs
  .readdirSync(inputFolder)
  .filter((e) => !path.basename(e).match(/^_/))
  .map((x) => path.resolve(inputFolder, x));

function tryBuildStyles() {
  try {
    for (let entry of entries) {
      buildStyles(entry);
    }
    console.log(`Done`);
  } catch (exc) {
    console.error(exc);
  }
}

tryBuildStyles();

let isWatch = false;
process.argv.forEach((p) => {
  if (p === "--watch") {
    isWatch = true;
  }
});

if (isWatch) {
  chokidar.watch(path.resolve(__dirname, "../css/")).on("change", (path) => {
    for (let entry of entries) {
      console.log(`"${path}" changed. Rebuilding "${entry}"`);
    }
    tryBuildStyles();
  });
}
